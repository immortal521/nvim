# Utils å·¥å…·åº“æ–‡æ¡£

è¿™ä¸ªå·¥å…·åº“ä¸º Neovim é…ç½®æä¾›äº†å¸¸ç”¨çš„å·¥å…·å‡½æ•°å’Œè¾…åŠ©åŠŸèƒ½ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ–¹ä¾¿åœ¨é…ç½®ä¸­å¤ç”¨ã€‚

## ğŸ“ æ¨¡å—ç»“æ„

```
lua/utils/
â”œâ”€â”€ init.lua      # ä¸»å…¥å£æ–‡ä»¶ï¼Œæä¾›åŸºç¡€å·¥å…·å‡½æ•°
â”œâ”€â”€ keymap.lua    # é”®ä½æ˜ å°„å·¥å…·
â”œâ”€â”€ colors.lua    # é¢œè‰²å·¥å…·
â”œâ”€â”€ lsp.lua       # LSP ç›¸å…³å·¥å…·
â””â”€â”€ terminal.lua  # ç»ˆç«¯é…ç½®å·¥å…·
```

## ğŸ”§ æ ¸å¿ƒå·¥å…· (init.lua)

### åŸºç¡€å·¥å…·å‡½æ•°

#### `Utils.log(msg)`
è®°å½•å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—ä¿¡æ¯ã€‚

**å‚æ•°:**
- `msg` (string): è¦è®°å½•çš„æ¶ˆæ¯

**ç¤ºä¾‹:**
```lua
Utils.log("é…ç½®åŠ è½½å®Œæˆ")
-- è¾“å‡º: [UTIL] 2024-01-01 12:00:00 - é…ç½®åŠ è½½å®Œæˆ
```

#### `Utils.map(mode, lhs, rhs, opts)`
è®¾ç½®é”®ä½æ˜ å°„çš„ç®€åŒ–å‡½æ•°ã€‚

**å‚æ•°:**
- `mode` (string): æ¨¡å¼ (å¦‚ "n", "i", "v" ç­‰)
- `lhs` (string): å·¦ä¾§é”®ä½
- `rhs` (string|function): å³ä¾§å‘½ä»¤æˆ–å‡½æ•°
- `opts` (table, å¯é€‰): é€‰é¡¹é…ç½®

**ç¤ºä¾‹:**
```lua
Utils.map("n", "<leader>w", ":w<CR>", { desc = "ä¿å­˜æ–‡ä»¶" })
```

#### `Utils.get_current_file_path()`
è·å–å½“å‰æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚

**è¿”å›å€¼:**
- (string): å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„

#### `Utils.file_exists(file_path)`
æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚

**å‚æ•°:**
- `file_path` (string): æ–‡ä»¶è·¯å¾„

**è¿”å›å€¼:**
- (boolean): æ–‡ä»¶æ˜¯å¦å­˜åœ¨

#### `Utils.create_dir(dir_path)`
åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ã€‚

**å‚æ•°:**
- `dir_path` (string): ç›®å½•è·¯å¾„

#### `Utils.is_win()`
æ£€æŸ¥å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸º Windowsã€‚

**è¿”å›å€¼:**
- (boolean): æ˜¯å¦ä¸º Windows ç³»ç»Ÿ

#### `Utils.async_function(callback)`
å¼‚æ­¥æ‰§è¡Œå‡½æ•°ï¼ˆå»¶è¿Ÿ 1 ç§’ï¼‰ã€‚

**å‚æ•°:**
- `callback` (function): å›è°ƒå‡½æ•°

### é¡¹ç›®å’Œ Git æ ¹ç›®å½•å·¥å…·

#### `Utils.get_project_root(opts)`
è·å–é¡¹ç›®æ ¹ç›®å½•ï¼Œæ”¯æŒç¼“å­˜å’Œ LSP æ ¹ç›®å½•æ£€æµ‹ã€‚

**å‚æ•°:**
- `opts` (table, å¯é€‰): é…ç½®é€‰é¡¹
  - `buf` (number): ç¼“å†²åŒºç¼–å·ï¼Œé»˜è®¤ä¸ºå½“å‰ç¼“å†²åŒº

**è¿”å›å€¼:**
- (string): é¡¹ç›®æ ¹ç›®å½•è·¯å¾„

**æ£€æµ‹é¡ºåº:**
1. LSP å®¢æˆ·ç«¯çš„æ ¹ç›®å½•
2. å¸¸è§é¡¹ç›®æ–‡ä»¶ (.git, go.mod, package.json, pyproject.toml)

#### `Utils.get_git_root(opts)`
è·å– Git ä»“åº“æ ¹ç›®å½•ã€‚

**å‚æ•°:**
- `opts` (table, å¯é€‰): é…ç½®é€‰é¡¹
  - `buf` (number): ç¼“å†²åŒºç¼–å·ï¼Œé»˜è®¤ä¸ºå½“å‰ç¼“å†²åŒº

**è¿”å›å€¼:**
- (string): Git æ ¹ç›®å½•è·¯å¾„

#### `Utils.get_bufs()`
è·å–æ‰€æœ‰å·²åˆ—å‡ºçš„ç¼“å†²åŒºã€‚

**è¿”å›å€¼:**
- (table): ç¼“å†²åŒºç¼–å·åˆ—è¡¨

## âŒ¨ï¸ é”®ä½æ˜ å°„å·¥å…· (keymap.lua)

### `Utils.keymap.map(config)`
ç»Ÿä¸€çš„é”®ä½æ˜ å°„å‡½æ•°ï¼Œæ”¯æŒæ›´ç®€æ´çš„é…ç½®æ ¼å¼ã€‚

**å‚æ•°:**
- `config` (table): é…ç½®è¡¨
  - `[1]` (string): å·¦ä¾§é”®ä½
  - `[2]` (string|function): å³ä¾§å‘½ä»¤æˆ–å‡½æ•°
  - `mode` (string|table, å¯é€‰): æ¨¡å¼ï¼Œé»˜è®¤ä¸º "n"
  - å…¶ä»–é€‰é¡¹å°†ä¼ é€’ç»™ `vim.keymap.set`

**ç¤ºä¾‹:**
```lua
Utils.keymap.map({
  "<leader>w",
  ":w<CR>",
  desc = "ä¿å­˜æ–‡ä»¶",
  mode = "n"
})
```

### `Utils.keymap.add(configs)`
æ‰¹é‡æ·»åŠ å¤šä¸ªé”®ä½æ˜ å°„ã€‚

**å‚æ•°:**
- `configs` (table): é…ç½®æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ `map` å‡½æ•°æ¥å—çš„é…ç½®

**ç¤ºä¾‹:**
```lua
Utils.keymap.add({
  { "<leader>w", ":w<CR>", desc = "ä¿å­˜æ–‡ä»¶" },
  { "<leader>q", ":q<CR>", desc = "é€€å‡º" },
  { "<leader>e", vim.cmd.Ex, desc = "æ–‡ä»¶æµè§ˆå™¨", mode = "n" }
})
```

## ğŸ¨ é¢œè‰²å·¥å…· (colors.lua)

### `Utils.colors.get_colors()`
è·å–å½“å‰ä¸»é¢˜çš„é¢œè‰²é…ç½®ã€‚

**è¿”å›å€¼:**
- (table): TokyoNight ä¸»é¢˜çš„é¢œè‰²è¡¨

**ç¤ºä¾‹:**
```lua
local colors = Utils.colors.get_colors()
print(colors.bg) -- èƒŒæ™¯è‰²
print(colors.fg) -- å‰æ™¯è‰²
```

## ğŸ”Œ LSP å·¥å…· (lsp.lua)

### `Utils.lsp.get_lsp_names()`
è·å–æ‰€æœ‰å¯ç”¨çš„ LSP æœåŠ¡å™¨åç§°ã€‚

**è¿”å›å€¼:**
- (table): LSP æœåŠ¡å™¨åç§°åˆ—è¡¨

**åŠŸèƒ½:**
- æ‰«æ `lsp/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.lua` æ–‡ä»¶
- è¿”å›æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ä½œä¸º LSP æœåŠ¡å™¨åç§°

## ğŸ–¥ï¸ ç»ˆç«¯å·¥å…· (terminal.lua)

### `Utils.terminal(shell)`
é…ç½®ç»ˆç«¯ç¯å¢ƒï¼Œæ”¯æŒå¤šç§ shellã€‚

**å‚æ•°:**
- `shell` (string, å¯é€‰): shell ç±»å‹ï¼Œå¦‚ "zsh", "bash", "pwsh" ç­‰

**æ”¯æŒçš„ shell:**
- Unix/Linux shell (zsh, bash ç­‰)
- PowerShell (pwsh, powershell)

**ç¤ºä¾‹:**
```lua
-- é…ç½® zsh
Utils.terminal("zsh")

-- é…ç½® PowerShellï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
Utils.terminal("pwsh")
```

**PowerShell ç‰¹æ€§:**
- è‡ªåŠ¨æ£€æµ‹ pwsh æˆ– powershell
- é…ç½® UTF-8 ç¼–ç 
- è®¾ç½®é€‚å½“çš„æ‰§è¡Œç­–ç•¥
- ä¼˜åŒ–è¾“å‡ºæ¸²æŸ“

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åœ¨é…ç½®ä¸­ä½¿ç”¨

```lua
-- åŠ è½½å·¥å…·åº“
local Utils = require("utils")

-- è®¾ç½®é”®ä½æ˜ å°„
Utils.keymap.add({
  { "<leader>p", function() print(Utils.get_project_root()) end, desc = "æ˜¾ç¤ºé¡¹ç›®æ ¹ç›®å½•" }
})

-- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if Utils.file_exists("~/.config/nvim/custom.lua") then
  dofile("~/.config/nvim/custom.lua")
end

-- è·å– LSP æœåŠ¡å™¨åˆ—è¡¨
local lsp_servers = Utils.lsp.get_lsp_names()
for _, server in ipairs(lsp_servers) do
  print("LSP æœåŠ¡å™¨:", server)
end
```

### åœ¨æ’ä»¶é…ç½®ä¸­ä½¿ç”¨

```lua
-- åœ¨æ’ä»¶é…ç½®ä¸­ä½¿ç”¨å·¥å…·å‡½æ•°
require("plugins.nvim-tree").setup({
  on_attach = function(bufnr)
    local root = Utils.get_project_root({ buf = bufnr })
    -- ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•è¿›è¡Œé…ç½®
  end
})
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜æœºåˆ¶**: `get_project_root` å’Œ `get_git_root` ä½¿ç”¨ç¼“å†²åŒºçº§åˆ«çš„ç¼“å­˜ï¼Œæé«˜æ€§èƒ½
2. **è·¨å¹³å°å…¼å®¹**: æ‰€æœ‰è·¯å¾„å¤„ç†éƒ½è€ƒè™‘äº† Windows å’Œ Unix ç³»ç»Ÿçš„å·®å¼‚
3. **æ‡’åŠ è½½**: å·¥å…·æ¨¡å—é‡‡ç”¨æ‡’åŠ è½½æœºåˆ¶ï¼Œåªåœ¨éœ€è¦æ—¶æ‰åŠ è½½å…·ä½“æ¨¡å—
4. **ç±»å‹æ³¨è§£**: æ‰€æœ‰å‡½æ•°éƒ½æä¾›äº†å®Œæ•´çš„ç±»å‹æ³¨è§£ï¼Œä¾¿äºå¼€å‘æ—¶è·å¾—æ™ºèƒ½æç¤º

è¿™ä¸ªå·¥å…·åº“ä¸º Neovim é…ç½®æä¾›äº†åšå®çš„åŸºç¡€ï¼Œè®©é…ç½®ä»£ç æ›´åŠ ç®€æ´å’Œå¯ç»´æŠ¤ã€‚